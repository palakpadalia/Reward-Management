import { Fragment, useState, useEffect } from 'react';
import { Link } from 'react-router-dom';
import Pageheader from '../../../components/common/pageheader/pageheader';
import { TiUser } from 'react-icons/ti';
import { useFrappeGetCall } from 'frappe-react-sdk';
import axios from 'axios';
import { format } from 'date-fns';
import '../../../assets/css/header.css';
import '../../../assets/css/style.css';

const iconMap = {
    'ti-user': TiUser,
};

interface NotificationData {
    name: string;
    subject: string;
    email_content: string;
    document_type: string;
    for_user: string;
    creation: string;
}

interface Notification {
    id: string;
    color: string;
    avatarColor: string;
    icon: keyof typeof iconMap; 
    subjectHTML: string;
    email_contentHTML: string;
    timestamp: string;
    date: string;
}

const NotificationsDashboard = () => {
    const { data, error, isLoading } = useFrappeGetCall('reward_management.api.admin_notifications.get_notifications_log');
    const [notifications, setNotifications] = useState<Notification[]>([]);
    const [notificationCount, setNotificationCount] = useState<number>(0);

    useEffect(() => {
        const fetchUserEmailAndInitScanner = async () => {
            try {
                const userResponse = await axios.get('/api/method/frappe.auth.get_logged_user');
                console.log("userData:", userResponse.data.message);
            } catch (err) {
                console.error("Error fetching user data:", err);
            }
        };

        fetchUserEmailAndInitScanner();
    }, []);

    useEffect(() => {
        if (data && Array.isArray(data.message)) {
            console.log("Fetched notifications data:", data.message);

            const notificationsData: Notification[] = data.message.map((notif: NotificationData) => {
                const formattedDate = format(new Date(notif.creation), 'dd MMM yyyy');

                // Ensure links are absolute paths or correctly resolved
                // You may need to adjust this based on your server configuration
                // const sanitizedContent = notif.email_content.replace(/href="..\/\.\.\//g, 'href="/');

                return {
                    id: notif.name,
                    color: 'primary',
                    avatarColor: 'bg-primary',
                    icon: 'ti-user',
                    subjectHTML: notif.subject,
                    email_contentHTML: notif.email_content,
                    timestamp: '12 mins ago',
                    date: formattedDate,
                };
            });
            
            setNotifications(notificationsData);
            setNotificationCount(notificationsData.length);
        }
    }, [data]);

    const handleLinkClick = (event: React.MouseEvent<HTMLAnchorElement, MouseEvent>) => {
        const href = event.currentTarget.getAttribute('href');
        if (href) {
            event.preventDefault();
            window.location.href = href;
        }
    };

    if (isLoading) return <div>Loading...</div>;
    if (error) return <div>Error loading notifications</div>;

    return (
        <Fragment>
            <Pageheader currentpage="Notifications" activepage="Pages" mainpage="Notifications" />
            <div className="container">
                <div className="grid grid-cols-12 !mx-auto">
                    <div className="xxl:col-span-2 col-span-12"></div>
                    <div className="xxl:col-span-8 xl:col-span-12 lg:col-span-12 md:col-span-12 sm:col-span-12 col-span-12">
                        <div className="notification-list">
                            {notifications.length > 0 ? (
                                notifications.map((notification) => {
                                    const IconComponent = iconMap[notification.icon] || TiUser;
                                    return (
                                        <div key={notification.id} className="box un-read">
                                            <div className="box-body !p-4">
                                                <Link to="#">
                                                    <div className="flex items-start mt-0 flex-wrap">
                                                        <div className="inline-flex justify-center items-center w-[2.5rem] h-[2.5rem] leading-[2.5rem] text-[0.8rem] rounded-full">
                                                            <span className={`avatar avatar-md online me-4 avatar-rounded rounded-full`} style={{ backgroundColor: `var(--${notification.avatarColor})` }}>
                                                                <IconComponent className="text-2xl" />
                                                            </span>
                                                        </div>
                                                        <div className="flex-grow">
                                                            <div className="sm:flex items-center">
                                                                <div className="sm:mt-0">
                                                                    <p className="mb-0 text-[.875rem] font-semibold">{notification.subjectHTML}</p>
                                                                    <p
                                                                        className="mb-0 text-[#8c9097] dark:text-white/50"
                                                                        dangerouslySetInnerHTML={{ __html: notification.email_contentHTML }}
                                                                    />
                                                                    <span className="mb-0 block text-[#8c9097] dark:text-white/50 text-[0.75rem]">{notification.timestamp}</span>
                                                                </div>
                                                                <div className="ms-auto">
                                                                    <span className="ltr:float-right rtl:float-left badge bg-light text-[#8c9097] dark:text-white/50 whitespace-nowrap">
                                                                        {notification.date}
                                                                    </span>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </Link>
                                            </div>
                                        </div>
                                    );
                                })
                            ) : (
                                <div>No notifications available</div>
                            )}
                        </div>
                    </div>
                    <div className="xxl:col-span-2 col-span-12"></div>
                </div>
            </div>
        </Fragment>
    );
};

export default NotificationsDashboard;
